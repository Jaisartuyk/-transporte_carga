{% extends 'base.html' %}
{% load static %}

{% block title %}Centro de Monitoreo GPS{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #667eea;
        --success-color: #48bb78;
        --warning-color: #ed8936;
        --danger-color: #f56565;
        --dark-color: #1a202c;
        --light-color: #f7fafc;
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }

    .monitoring-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .monitoring-header h1 {
        font-size: 32px;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
    }

    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-color: var(--primary-color);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        margin-bottom: 15px;
    }

    .stat-value {
        font-size: 36px;
        font-weight: 800;
        color: var(--dark-color);
        line-height: 1;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 14px;
        color: #718096;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .map-container {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        height: calc(100vh - 280px);
        min-height: 500px;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    .drivers-panel {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        height: calc(100vh - 280px);
        min-height: 500px;
        overflow-y: auto;
    }

    .drivers-panel h5 {
        font-size: 18px;
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 3px solid var(--primary-color);
    }

    .driver-card {
        background: var(--light-color);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
    }

    .driver-card:hover {
        background: white;
        border-color: var(--primary-color);
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }

    .driver-card.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
    }

    .driver-card.active .driver-name,
    .driver-card.active .driver-info {
        color: white !important;
    }

    .driver-name {
        font-size: 16px;
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 5px;
    }

    .driver-info {
        font-size: 13px;
        color: #718096;
        margin-bottom: 3px;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-active {
        background: #c6f6d5;
        color: #22543d;
    }

    .pulse-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--success-color);
        display: inline-block;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.5;
            transform: scale(1.1);
        }
    }

    .last-update {
        font-size: 11px;
        color: #a0aec0;
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* Scrollbar personalizado */
    .drivers-panel::-webkit-scrollbar {
        width: 8px;
    }

    .drivers-panel::-webkit-scrollbar-track {
        background: var(--light-color);
        border-radius: 10px;
    }

    .drivers-panel::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 10px;
    }

    .drivers-panel::-webkit-scrollbar-thumb:hover {
        background: #764ba2;
    }

    /* Animaci√≥n de entrada */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in-up {
        animation: fadeInUp 0.6s ease-out;
    }

    /* Toast de notificaci√≥n */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideInRight 0.4s ease-out;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="monitoring-header fade-in-up">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1>
                    <i class="bi bi-broadcast-pin"></i> Centro de Monitoreo GPS
                </h1>
                <p class="text-muted mb-0" style="font-size: 14px;">
                    <span class="pulse-dot"></span>
                    Rastreo en tiempo real de toda la flota
                </p>
            </div>
            <div class="col-md-6 text-end">
                <span class="badge bg-success" style="font-size: 14px; padding: 10px 20px;">
                    <i class="bi bi-wifi"></i> Conectado
                </span>
            </div>
        </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card fade-in-up" style="animation-delay: 0.1s;">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="bi bi-truck"></i>
                </div>
                <div class="stat-value" id="total-vehicles">{{ envios_en_ruta.count }}</div>
                <div class="stat-label">Veh√≠culos en Ruta</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card fade-in-up" style="animation-delay: 0.2s;">
                <div class="stat-icon" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white;">
                    <i class="bi bi-geo-alt-fill"></i>
                </div>
                <div class="stat-value" id="total-updates">0</div>
                <div class="stat-label">Actualizaciones Hoy</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card fade-in-up" style="animation-delay: 0.3s;">
                <div class="stat-icon" style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white;">
                    <i class="bi bi-speedometer2"></i>
                </div>
                <div class="stat-value" id="avg-speed">0</div>
                <div class="stat-label">Velocidad Promedio</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card fade-in-up" style="animation-delay: 0.4s;">
                <div class="stat-icon" style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); color: white;">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="stat-value" id="last-update-time">--:--</div>
                <div class="stat-label">√öltima Actualizaci√≥n</div>
            </div>
        </div>
    </div>

    <!-- Mapa y Panel de Conductores -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="map-container fade-in-up" style="animation-delay: 0.5s;">
                <div id="map"></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="drivers-panel fade-in-up" style="animation-delay: 0.6s;">
                <h5>
                    <i class="bi bi-people-fill"></i> Conductores Activos
                    <span class="badge bg-primary ms-2" id="drivers-count">{{ envios_en_ruta.count }}</span>
                </h5>
                <div id="drivers-list">
                    {% for envio in envios_en_ruta %}
                    <div class="driver-card" data-envio-id="{{ envio.id }}" onclick="focusDriver({{ envio.id }})">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="driver-name">
                                    <i class="bi bi-person-circle"></i>
                                    {{ envio.vehiculo.conductor.nombre_completo|default:"Sin nombre" }}
                                </div>
                                <div class="driver-info">
                                    <i class="bi bi-truck"></i> {{ envio.vehiculo.placa }}
                                </div>
                                <div class="driver-info">
                                    <i class="bi bi-file-text"></i> Gu√≠a: {{ envio.numero_guia }}
                                </div>
                                <div class="last-update">
                                    <i class="bi bi-clock"></i>
                                    <span class="update-time">Cargando...</span>
                                </div>
                            </div>
                            <span class="status-badge status-active">
                                <i class="bi bi-circle-fill"></i> Activo
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 48px; color: #cbd5e0;"></i>
                        <p class="text-muted mt-3">No hay conductores en ruta</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places"></script>
<script>
    // üéØ CONFIGURACI√ìN
    const UPDATE_INTERVAL = 10000; // 10 segundos
    let map;
    let markers = {};
    let polylines = {};
    let infoWindow;
    let selectedDriver = null;

    // üó∫Ô∏è INICIALIZAR MAPA
    function initMap() {
        const initialCenter = { lat: -1.8312, lng: -78.1834 };

        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 7,
            center: initialCenter,
            mapTypeId: 'roadmap',
            styles: [
                {
                    featureType: "poi",
                    elementType: "labels",
                    stylers: [{ visibility: "off" }]
                }
            ],
            mapTypeControl: true,
            streetViewControl: false,
            fullscreenControl: true
        });

        infoWindow = new google.maps.InfoWindow();

        // Cargar ubicaciones iniciales
        loadLocations();

        // Actualizar cada 10 segundos
        setInterval(loadLocations, UPDATE_INTERVAL);
    }

    // üîî MOSTRAR NOTIFICACI√ìN
    function showNotification(message, type = 'info') {
        // Si no hay soporte para Bootstrap Toast, usar alert nativo
        if (typeof bootstrap === 'undefined' || !bootstrap.Toast) {
            console.log(`[${type.toUpperCase()}] ${message}`);
            return;
        }

        // Crear contenedor de notificaciones si no existe
        let container = document.getElementById('notifications-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notifications-container';
            container.style.position = 'fixed';
            container.style.top = '20px';
            container.style.right = '20px';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }

        // Crear toast
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.role = 'alert';
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        const now = new Date();
        const timeStr = now.toLocaleTimeString('es-EC', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${timeStr}</strong> - ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
            </div>
        `;
        
        container.appendChild(toast);
        
        // Inicializar toast de Bootstrap
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 5000
        });
        
        // Eliminar el toast despu√©s de que se oculte
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
        
        bsToast.show();
    }

    // üìç CARGAR UBICACIONES
    async function loadLocations() {
        try {
            console.log('[MONITOR] üîÑ Solicitando ubicaciones...');
            const response = await fetch('/api/ubicaciones-activas/');
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            console.log(`[MONITOR] üìç ${data.length} ubicaciones recibidas`);

            if (data.length > 0) {
                // Actualizar estad√≠sticas
                updateStats(data);
                
                // Actualizar marcadores
                updateMarkers(data);
                
                // Actualizar lista de conductores
                updateDriversList(data);
                
                // Mostrar √∫ltima actualizaci√≥n
                const now = new Date();
                const timeStr = now.toLocaleTimeString('es-EC', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                document.getElementById('last-update-time').textContent = timeStr;
                document.getElementById('last-update-time').classList.remove('text-danger');
                
                // Mostrar notificaci√≥n de √©xito
                if (typeof showNotification === 'function') {
                    showNotification('Ubicaciones actualizadas', 'success');
                }
            } else {
                console.warn('[MONITOR] No hay ubicaciones disponibles');
                document.getElementById('last-update-time').classList.add('text-danger');
                if (typeof showNotification === 'function') {
                    showNotification('No hay conductores activos', 'warning');
                }
            }

        } catch (error) {
            console.error('[MONITOR] ‚ùå Error al cargar ubicaciones:', error);
            document.getElementById('last-update-time').classList.add('text-danger');
            if (typeof showNotification === 'function') {
                showNotification('Error al cargar ubicaciones', 'danger');
            }
        }
    }

    // üìä ACTUALIZAR ESTAD√çSTICAS
    function updateStats(data) {
        const totalUpdates = data.reduce((sum, d) => sum + (d.updates_count || 0), 0);
        const avgSpeed = data.length > 0 
            ? (data.reduce((sum, d) => sum + (d.speed || 0), 0) / data.length).toFixed(0)
            : 0;

        document.getElementById('total-vehicles').textContent = data.length;
        document.getElementById('total-updates').textContent = totalUpdates;
        document.getElementById('avg-speed').textContent = avgSpeed + ' km/h';
    }

    // üöó ACTUALIZAR MARCADORES
    function updateMarkers(data) {
        console.log('[MAP] Actualizando marcadores con datos:', data);
        
        // Asegurarse de que markers y polylines est√©n inicializados
        if (typeof markers === 'undefined') window.markers = {};
        if (typeof polylines === 'undefined') window.polylines = {};

        // Limpiar marcadores antiguos
        const currentIds = data.map(d => d.envio_id.toString()); // Convertir a string para comparaci√≥n consistente
        
        Object.keys(markers).forEach(id => {
            if (!currentIds.includes(id)) {
                if (markers[id]) {
                    markers[id].setMap(null);
                    delete markers[id];
                }
            }
        });

        // Limpiar polylines antiguos
        Object.keys(polylines).forEach(id => {
            if (!currentIds.includes(id)) {
                if (polylines[id]) {
                    polylines[id].setMap(null);
                    delete polylines[id];
                }
            }
        });

        // Crear o actualizar marcadores
        data.forEach(driver => {
            const driverId = driver.envio_id.toString(); // Asegurar que el ID sea string
            const position = { 
                lat: parseFloat(driver.lat), 
                lng: parseFloat(driver.lng) 
            };

            console.log(`[MAP] Procesando conductor ${driver.conductor} (ID: ${driverId}) en`, position);

            if (markers[driverId]) {
                // Actualizar posici√≥n existente
                console.log(`[MAP] Actualizando marcador existente para ID ${driverId}`);
                markers[driverId].setPosition(position);

                // Actualizar polyline si existe
                if (polylines[driverId]) {
                    const path = polylines[driverId].getPath();
                    path.push(new google.maps.LatLng(position));
                    
                    // Limitar el n√∫mero de puntos en la ruta para mejorar rendimiento
                    if (path.getLength() > 100) {
                        path.removeAt(0);
                    }
                }
            } else {
                // Crear nuevo marcador
                console.log(`[MAP] Creando nuevo marcador para ID ${driverId}`);
                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: driver.conductor || 'Conductor',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: '#667eea',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 3
                    },
                    animation: google.maps.Animation.DROP
                });

                // InfoWindow
                marker.addListener('click', () => {
                    const content = `
                        <div style="padding: 15px; min-width: 280px;">
                            <h6 style="font-weight: 700; color: #1e293b; margin-bottom: 12px;">
                                <i class="bi bi-person-circle" style="color: #667eea;"></i> ${driver.conductor || 'N/A'}
                            </h6>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 14px;">
                                <span style="color: #64748b;">Veh√≠culo:</span>
                                <span style="color: #0f172a; font-weight: 600;">${driver.vehiculo || 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 14px;">
                                <span style="color: #64748b;">Gu√≠a:</span>
                                <span style="color: #0f172a; font-weight: 600;">${driver.guia || 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 14px;">
                                <span style="color: #64748b;">Velocidad:</span>
                                <span style="color: #0f172a; font-weight: 600;">${driver.speed || 0} km/h</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px;">
                                <span style="color: #64748b;">√öltima actualizaci√≥n:</span>
                                <span style="color: #0f172a; font-weight: 600;">${driver.actualizacion || 'N/A'}</span>
                            </div>
                        </div>
                    `;
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });

                markers[driverId] = marker;

                // Crear polyline para la ruta
                polylines[driverId] = new google.maps.Polyline({
                    path: [position],
                    geodesic: true,
                    strokeColor: '#667eea',
                    strokeOpacity: 0.8,
                    strokeWeight: 3,
                    map: map
                });
                
                console.log(`[MAP] Marcador creado para ID ${driverId} en`, position);
            }
        });
        
        console.log('[MAP] Actualizaci√≥n de marcadores completada');
    }

    // üìã ACTUALIZAR LISTA DE CONDUCTORES
    function updateDriversList(data) {
        data.forEach(driver => {
            const card = document.querySelector(`[data-envio-id="${driver.envio_id}"]`);
            if (card) {
                const timeSpan = card.querySelector('.update-time');
                if (timeSpan) {
                    timeSpan.textContent = driver.actualizacion;
                }
            }
        });
    }

    // ENFOCAR CONDUCTOR
    function focusDriver(envioId) {
        // Remover selecci√≥n anterior
        document.querySelectorAll('.driver-card').forEach(card => {
            card.classList.remove('active');
        });

        // Seleccionar nuevo
        const card = document.querySelector(`[data-envio-id="${envioId}"]`);
        if (card) {
            card.classList.add('active');
        }

        // Centrar mapa en el marcador
        if (markers[envioId]) {
            map.setCenter(markers[envioId].getPosition());
            map.setZoom(14);
            google.maps.event.trigger(markers[envioId], 'click');
        }

        selectedDriver = envioId;
    }

    // üîî MOSTRAR NOTIFICACI√ìN
    function showNotification(message, type = 'info') {
        // Si no hay soporte para Bootstrap Toast, usar alert nativo
        if (typeof bootstrap === 'undefined' || !bootstrap.Toast) {
            console.log(`[${type.toUpperCase()}] ${message}`);
            return;
        }

        // Crear contenedor de notificaciones si no existe
        let container = document.getElementById('notifications-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notifications-container';
            container.style.position = 'fixed';
            container.style.top = '20px';
            container.style.right = '20px';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }

        // Crear toast
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.role = 'alert';
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        const now = new Date();
        const timeStr = now.toLocaleTimeString('es-EC', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${timeStr}</strong> - ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
            </div>
        `;
        
        container.appendChild(toast);
        
        // Inicializar toast de Bootstrap
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 5000
        });
        
        // Eliminar el toast despu√©s de que se oculte
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
        
        bsToast.show();
    }

    // üöÄ INICIALIZAR
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        console.log('[MONITOR] Centro de monitoreo inicializado');
        
        // Cargar ubicaciones inmediatamente
        loadLocations();
        
        // Actualizar cada 10 segundos
        setInterval(loadLocations, 10000);
        console.log('[MONITOR] Actualizaci√≥n autom√°tica activada (cada 10 segundos)');
    });
</script>
{% endblock %}
