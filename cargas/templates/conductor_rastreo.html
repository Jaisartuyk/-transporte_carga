{% extends 'base.html' %}
{% load static %}

{% block title %}Rastreo GPS - Conductor{% endblock %}

{% block extra_css %}
<style>
    .gps-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 28px;
        color: white;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        margin-bottom: 20px;
    }
    
    .gps-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 50px;
        font-size: 14px;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: pulse-badge 2s infinite;
    }
    
    @keyframes pulse-badge {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .stat-box {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .stat-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        opacity: 0.9;
        margin-bottom: 4px;
    }
    
    .stat-value {
        font-size: 22px;
        font-weight: 700;
    }
    
    .control-btn {
        width: 100%;
        padding: 16px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 15px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    
    .btn-start {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }
    
    .btn-stop {
        background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        color: white;
    }
    
    .map-container {
        position: relative;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        height: 600px;
    }
    
    #map {
        width: 100%;
        height: 100%;
    }
    
    .settings-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-top: 20px;
    }
    
    .settings-title {
        font-size: 15px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .custom-select {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .custom-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .envio-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 16px;
        padding: 20px;
        color: white;
        margin-top: 20px;
    }
    
    .envio-title {
        font-size: 15px;
        font-weight: 700;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .envio-detail {
        margin-bottom: 12px;
    }
    
    .envio-label {
        font-size: 11px;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .envio-value {
        font-size: 14px;
        font-weight: 600;
        margin-top: 4px;
    }
    
    .pulse-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #10b981;
        animation: pulse-dot 2s infinite;
    }
    
    @keyframes pulse-dot {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        50% {
            box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header" data-aos="fade-down">
    <div>
        <h1 class="page-title">üìç Rastreo GPS en Tiempo Real</h1>
        <p class="page-subtitle">Sistema de seguimiento inteligente para conductores</p>
    </div>
</div>

<div class="row g-4">
    <!-- Panel de Control GPS -->
    <div class="col-lg-4">
        <!-- Card Principal GPS -->
        <div class="gps-card" data-aos="fade-up">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 style="font-weight: 700; margin: 0;">
                    <i class="bi bi-broadcast"></i> Control GPS
                </h5>
                <div class="pulse-dot"></div>
            </div>
            
            <!-- Estado del GPS -->
            <div id="gps-status" class="gps-status-badge mb-4">
                <i class="bi bi-info-circle"></i>
                <span>Inicializando...</span>
            </div>
            
            <!-- Estad√≠sticas -->
            <div id="stats-container" style="display: none;">
                <div class="stat-box">
                    <div class="stat-label">Ubicaciones Enviadas</div>
                    <div class="stat-value" id="locations-sent">0</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-label">Velocidad Actual</div>
                    <div class="stat-value" id="current-speed">0 km/h</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-label">Precisi√≥n GPS</div>
                    <div class="stat-value" id="current-accuracy">- m</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-label">√öltima Actualizaci√≥n</div>
                    <div class="stat-value" id="last-update" style="font-size: 14px;">-</div>
                </div>
            </div>
            
            <!-- Botones de Control -->
            <div class="mt-4">
                <button id="btn-start-tracking" class="control-btn btn-start" onclick="startTracking()">
                    <i class="bi bi-play-circle-fill" style="font-size: 20px;"></i>
                    <span>Iniciar Rastreo</span>
                </button>
                <button id="btn-stop-tracking" class="control-btn btn-stop" onclick="stopTracking()" style="display: none;">
                    <i class="bi bi-stop-circle-fill" style="font-size: 20px;"></i>
                    <span>Detener Rastreo</span>
                </button>
            </div>
        </div>
        
        <!-- Configuraci√≥n -->
        <div class="settings-card" data-aos="fade-up" data-aos-delay="100">
            <div class="settings-title">
                <i class="bi bi-gear-fill text-primary"></i>
                Configuraci√≥n
            </div>
            
            <div class="mb-3">
                <label for="update-interval" class="form-label" style="font-size: 13px; font-weight: 600;">
                    Frecuencia de Actualizaci√≥n
                </label>
                <select id="update-interval" class="custom-select" onchange="updateInterval()">
                    <option value="10000">‚ö° Cada 10 segundos (Alta precisi√≥n)</option>
                    <option value="30000" selected>‚úÖ Cada 30 segundos (Recomendado)</option>
                    <option value="60000">üîã Cada 1 minuto (Ahorro de bater√≠a)</option>
                    <option value="120000">üíö Cada 2 minutos (M√°ximo ahorro)</option>
                </select>
            </div>
            
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="high-accuracy" checked onchange="toggleAccuracy()" style="cursor: pointer;">
                <label class="form-check-label" for="high-accuracy" style="font-size: 13px; cursor: pointer;">
                    Alta precisi√≥n GPS
                </label>
            </div>
        </div>
        
        <!-- Informaci√≥n del Env√≠o Activo -->
        {% if envio_activo %}
        <div class="envio-card" data-aos="fade-up" data-aos-delay="200">
            <div class="envio-title">
                <i class="bi bi-box-seam-fill"></i>
                Env√≠o Activo
            </div>
            
            <div class="envio-detail">
                <div class="envio-label">Gu√≠a</div>
                <div class="envio-value">{{ envio_activo.numero_guia }}</div>
            </div>
            
            <div class="envio-detail">
                <div class="envio-label">Destino</div>
                <div class="envio-value">{{ envio_activo.destino|truncatewords:5 }}</div>
            </div>
            
            <div class="envio-detail">
                <div class="envio-label">Cliente</div>
                <div class="envio-value">{{ envio_activo.cliente.get_full_name }}</div>
            </div>
            
            <a href="{% url 'envio_detalle' envio_activo.id %}" class="btn btn-light w-100 mt-3" style="font-weight: 600;">
                <i class="bi bi-eye"></i> Ver Detalles
            </a>
        </div>
        {% else %}
        <div class="envio-card" data-aos="fade-up" data-aos-delay="200">
            <div class="text-center py-3">
                <i class="bi bi-inbox" style="font-size: 48px; opacity: 0.5;"></i>
                <p style="margin-top: 12px; font-size: 14px; opacity: 0.9;">
                    No tienes env√≠os activos
                </p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Mapa -->
    <div class="col-lg-8">
        <div class="map-container" data-aos="fade-up">
            <div id="map"></div>
        </div>
        
        <!-- Instrucciones -->
        <div class="alert alert-info mt-4" style="border-radius: 16px; border: none; background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);">
            <h6 style="font-weight: 700; color: #1e40af; margin-bottom: 12px;">
                <i class="bi bi-info-circle-fill"></i> Instrucciones de Uso
            </h6>
            <ul style="margin: 0; padding-left: 20px; color: #1e40af; font-size: 14px; line-height: 1.8;">
                <li>Haz clic en <strong>"Iniciar Rastreo"</strong> para comenzar</li>
                <li>Acepta los permisos de ubicaci√≥n cuando te lo pida el navegador</li>
                <li>Tu ubicaci√≥n se enviar√° autom√°ticamente cada 30 segundos</li>
                <li>Mant√©n la app abierta durante el viaje para mejor precisi√≥n</li>
                <li>Si pierdes conexi√≥n, las ubicaciones se guardar√°n y enviar√°n despu√©s</li>
                <li>Puedes ajustar la frecuencia seg√∫n tu preferencia</li>
            </ul>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places"></script>
<!-- Background Location Tracker -->
<script src="{% static 'js/background-location.js' %}"></script>
<script>
    let gpsTracker = null;
    let map = null;
    let currentMarker = null;
    let pathPolyline = null;
    let locationsSent = 0;
    let infoWindow = null;
    
    // Inicializar mapa y rastreo en segundo plano
    document.addEventListener('DOMContentLoaded', async function() {
        {% if envio_activo %}
        // üöÄ ACTIVAR RASTREO EN SEGUNDO PLANO
        try {
            // Solicitar permiso de notificaciones
            if ('Notification' in window && Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                console.log('üì¢ Permiso de notificaciones:', permission);
            }
            
            // Iniciar rastreo en segundo plano
            await window.backgroundTracker.startTracking({{ envio_activo.id }});
            
            console.log('‚úÖ Rastreo en segundo plano activado');
            
            // Mostrar indicador visual
            const statusDiv = document.getElementById('gps-status');
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success" style="margin-top: 15px; border-radius: 12px;">
                        <i class="bi bi-broadcast-pin"></i>
                        <strong>Rastreo en Segundo Plano Activo</strong><br>
                        <small>Tu ubicaci√≥n se comparte autom√°ticamente incluso con la app minimizada</small>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('‚ùå Error al iniciar rastreo en segundo plano:', error);
            
            // Mostrar error al usuario
            const statusDiv = document.getElementById('gps-status');
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="alert alert-warning" style="margin-top: 15px; border-radius: 12px;">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Rastreo Limitado</strong><br>
                        <small>${error.message}. Usa el bot√≥n "Iniciar Rastreo" para modo manual.</small>
                    </div>
                `;
            }
        }
        {% endif %}
        // Crear mapa centrado en Ecuador
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -1.8312, lng: -78.1834 },
            zoom: 7,
            styles: [
                {
                    "featureType": "all",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#f5f5f5" }]
                },
                {
                    "featureType": "water",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#c9e9ff" }]
                },
                {
                    "featureType": "road",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#ffffff" }]
                }
            ],
            mapTypeControl: true,
            streetViewControl: true,
            fullscreenControl: true,
            zoomControl: true
        });
        
        // Inicializar polyline para el recorrido
        pathPolyline = new google.maps.Polyline({
            path: [],
            geodesic: true,
            strokeColor: '#667eea',
            strokeOpacity: 0.8,
            strokeWeight: 4
        });
        pathPolyline.setMap(map);
        
        // Inicializar InfoWindow
        infoWindow = new google.maps.InfoWindow();
        
        // üéØ AUTO-INICIAR RASTREO (sin necesidad de clic)
        {% if user.rol == 'conductor' %}
        setTimeout(() => {
            console.log('[GPS] Auto-iniciando rastreo...');
            autoStartTracking();
        }, 1500);
        {% endif %}
    });
    
    // üéØ FUNCI√ìN DE AUTO-INICIO
    function autoStartTracking() {
        // Verificar si ya est√° rastreando
        if (gpsTracker && gpsTracker.isActive && gpsTracker.isActive()) {
            console.log('[GPS] Ya est√° rastreando');
            return;
        }
        
        console.log('[GPS] Iniciando rastreo autom√°tico...');
        
        // Iniciar rastreo autom√°ticamente
        const interval = 30000; // 30 segundos
        const highAccuracy = true;
        
        gpsTracker = new BackgroundLocationTracker({
            updateInterval: interval,
            highAccuracy: highAccuracy,
            onLocationUpdate: handleLocationUpdate,
            onError: handleError
        });
        
        gpsTracker.start();
        
        // Guardar estado
        localStorage.setItem('gps_tracking_active', 'true');
        localStorage.setItem('gps_tracking_start_time', new Date().toISOString());
        
        // Actualizar UI con los IDs correctos
        const startBtn = document.getElementById('btn-start-tracking');
        const stopBtn = document.getElementById('btn-stop-tracking');
        const statusDiv = document.getElementById('gps-status');
        const statsContainer = document.getElementById('stats-container');
        
        if (startBtn) startBtn.style.display = 'none';
        if (stopBtn) stopBtn.style.display = 'inline-block';
        
        if (statusDiv) {
            statusDiv.className = 'gps-status-badge bg-success mb-4';
            statusDiv.innerHTML = `
                <i class="bi bi-broadcast-pin"></i>
                <span>üü¢ Rastreando Autom√°ticamente</span>
            `;
        }
        
        if (statsContainer) {
            statsContainer.style.display = 'block';
        }
        
        console.log('[GPS] ‚úÖ Rastreo iniciado autom√°ticamente');
    }
    
    // üîÑ REACTIVAR AL VOLVER A LA APP
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            console.log('[GPS] App visible de nuevo');
            
            // Verificar si debe estar rastreando
            const shouldTrack = localStorage.getItem('gps_tracking_active') === 'true';
            
            if (shouldTrack && (!gpsTracker || !gpsTracker.isActive || !gpsTracker.isActive())) {
                console.log('[GPS] Reactivando rastreo...');
                autoStartTracking();
            }
        }
    });
    
    // Iniciar rastreo (bot√≥n manual)
    function startTracking() {
        const interval = parseInt(document.getElementById('update-interval').value);
        const highAccuracy = document.getElementById('high-accuracy').checked;
        
        gpsTracker = new GPSTracker({
            updateInterval: interval,
            highAccuracy: highAccuracy,
            onLocationUpdate: handleLocationUpdate,
            onError: handleError
        });
        
        const started = gpsTracker.startTracking();
        
        if (started) {
            document.getElementById('btn-start-tracking').style.display = 'none';
            document.getElementById('btn-stop-tracking').style.display = 'block';
            document.getElementById('stats-container').style.display = 'block';
            
            updateStatus('Rastreando...', 'success');
        }
    }
    
    // Detener rastreo
    function stopTracking() {
        if (gpsTracker) {
            gpsTracker.stopTracking();
            gpsTracker = null;
        }
        
        document.getElementById('btn-start-tracking').style.display = 'block';
        document.getElementById('btn-stop-tracking').style.display = 'none';
        
        updateStatus('Rastreo detenido', 'warning');
    }
    
    // Manejar actualizaci√≥n de ubicaci√≥n
    function handleLocationUpdate(coords) {
        console.log('Nueva ubicaci√≥n:', coords);
        
        // Actualizar estad√≠sticas
        document.getElementById('current-speed').textContent = coords.speed ? (coords.speed * 3.6).toFixed(1) + ' km/h' : '0 km/h';
        document.getElementById('current-accuracy').textContent = coords.accuracy ? coords.accuracy.toFixed(0) + ' m' : '- m';
        document.getElementById('last-update').textContent = new Date(coords.timestamp).toLocaleTimeString();
        
        locationsSent++;
        document.getElementById('locations-sent').textContent = locationsSent;
        
        // Actualizar mapa
        updateMap(coords);
        
        updateStatus('Ubicaci√≥n actualizada', 'success');
    }
    
    // Manejar errores
    function handleError(error) {
        console.error('Error GPS:', error);
        updateStatus(error, 'danger');
    }
    
    // Actualizar mapa
    function updateMap(coords) {
        const latlng = { lat: coords.lat, lng: coords.lng };
        
        // Actualizar o crear marcador
        if (currentMarker) {
            currentMarker.setPosition(latlng);
        } else {
            currentMarker = new google.maps.Marker({
                position: latlng,
                map: map,
                title: 'Mi Ubicaci√≥n',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#667eea',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 3
                },
                animation: google.maps.Animation.DROP
            });
            
            // Agregar click listener para mostrar info
            currentMarker.addListener('click', function() {
                const content = `
                    <div style="padding: 12px; min-width: 250px;">
                        <h6 style="font-weight: 700; color: #1e293b; margin-bottom: 12px;">
                            <i class="bi bi-geo-alt-fill" style="color: #667eea;"></i> Mi Ubicaci√≥n Actual
                        </h6>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 13px;">
                            <span style="color: #64748b;">Latitud:</span>
                            <span style="color: #0f172a; font-weight: 600;">${coords.lat.toFixed(6)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 13px;">
                            <span style="color: #64748b;">Longitud:</span>
                            <span style="color: #0f172a; font-weight: 600;">${coords.lng.toFixed(6)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 13px;">
                            <span style="color: #64748b;">Precisi√≥n:</span>
                            <span style="color: #0f172a; font-weight: 600;">${coords.accuracy ? coords.accuracy.toFixed(0) + ' m' : '-'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px;">
                            <span style="color: #64748b;">Velocidad:</span>
                            <span style="color: #0f172a; font-weight: 600;">${coords.speed ? (coords.speed * 3.6).toFixed(1) + ' km/h' : '0 km/h'}</span>
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #64748b;">
                            <i class="bi bi-clock"></i> ${new Date(coords.timestamp).toLocaleString()}
                        </div>
                    </div>
                `;
                infoWindow.setContent(content);
                infoWindow.open(map, currentMarker);
            });
        }
        
        // Agregar punto al recorrido
        const path = pathPolyline.getPath();
        path.push(latlng);
        
        // Centrar mapa
        map.setCenter(latlng);
        map.setZoom(15);
    }
    
    // Actualizar estado
    function updateStatus(message, type) {
        const statusEl = document.getElementById('gps-status');
        const icons = {
            success: 'check-circle-fill',
            danger: 'x-circle-fill',
            warning: 'exclamation-circle-fill',
            info: 'info-circle-fill'
        };
        
        statusEl.innerHTML = `
            <i class="bi bi-${icons[type] || 'info-circle'}"></i>
            <span>${message}</span>
        `;
        
        // Cambiar color seg√∫n tipo
        if (type === 'success') {
            statusEl.style.background = 'rgba(16, 185, 129, 0.3)';
        } else if (type === 'danger') {
            statusEl.style.background = 'rgba(239, 68, 68, 0.3)';
        } else if (type === 'warning') {
            statusEl.style.background = 'rgba(245, 158, 11, 0.3)';
        } else {
            statusEl.style.background = 'rgba(255, 255, 255, 0.2)';
        }
    }
    
    // Actualizar intervalo
    function updateInterval() {
        if (gpsTracker && gpsTracker.isActive()) {
            const interval = parseInt(document.getElementById('update-interval').value);
            gpsTracker.updateInterval = interval;
            console.log('Intervalo actualizado:', interval);
        }
    }
    
    // Cambiar precisi√≥n
    function toggleAccuracy() {
        if (gpsTracker && gpsTracker.isActive()) {
            const highAccuracy = document.getElementById('high-accuracy').checked;
            gpsTracker.highAccuracy = highAccuracy;
            console.log('Precisi√≥n actualizada:', highAccuracy);
        }
    }
    
    // üéØ MANTENER RASTREO AL SALIR (SIN MENSAJE MOLESTO)
    window.addEventListener('beforeunload', function(e) {
        // NO detener el rastreo, solo guardar el estado
        if (tracker && tracker.isTracking) {
            localStorage.setItem('gps_tracking_active', 'true');
            localStorage.setItem('gps_last_active', new Date().toISOString());
            console.log('[GPS] Estado guardado para continuar en segundo plano');
        }
        // NO mostrar mensaje de confirmaci√≥n
        // NO usar e.preventDefault() ni e.returnValue
    });
</script>
{% endblock %}
